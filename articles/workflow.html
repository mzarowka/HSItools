<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="HSItools">
<title>Basic workflow • HSItools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Basic workflow">
<meta property="og:description" content="HSItools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">HSItools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9008</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/shiny_gui.html">Graphical user interface with Shiny</a>
    <a class="dropdown-item" href="../articles/workflow.html">Basic workflow</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mzarowka/HSItools/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Basic workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mzarowka/HSItools/blob/HEAD/vignettes/workflow.Rmd" class="external-link"><code>vignettes/workflow.Rmd</code></a></small>
      <div class="d-none name"><code>workflow.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mzarowka/HSItools" class="external-link">HSItools</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: replacing previous import 'DT::dataTableOutput' by</span></span>
<span><span class="co">#&gt; 'shiny::dataTableOutput' when loading 'HSItools'</span></span>
<span><span class="co">#&gt; Warning: replacing previous import 'DT::renderDataTable' by</span></span>
<span><span class="co">#&gt; 'shiny::renderDataTable' when loading 'HSItools'</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; terra 1.7.71</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'terra'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:patchwork':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     area</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:terra':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, union</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'tidyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:terra':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     extract</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>Here, we present a basic workflow for a single core. It is assumed
that the output of the <code><a href="../reference/run_core.html">run_core()</a></code> function is available and
stored on the disk.</p>
<p>We’re using some internal data here, substantially reducing spatial
resolution.</p>
<div class="section level2">
<h2 id="basic-workflow">Basic workflow<a class="anchor" aria-label="anchor" href="#basic-workflow"></a>
</h2>
<p>Typically at this point you are going to use the shiny app output of
the <code><a href="../reference/run_core.html">run_core()</a></code> function stored in the *.rds file. Here, for
the vignette we recreate this output by hand. You can also produce these
files this way, without running shiny app.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load run_core() output</span></span>
<span></span>
<span><span class="va">core</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  analysisOptions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    normalize <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    integration <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    proxies <span class="op">=</span> <span class="st">'rabd_b660b670'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">560.84</span>, <span class="fl">585.49</span>, <span class="fl">610.24</span>, <span class="fl">635.08</span>, <span class="fl">660.02</span>, <span class="fl">685.05</span>, <span class="fl">710.19</span>, <span class="fl">735.41</span><span class="op">)</span>,</span>
<span>  cropImage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">948</span>, <span class="fl">1283</span>, <span class="fl">13143</span>, <span class="fl">13211</span><span class="op">)</span>,</span>
<span>  simpleRGB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ext <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">88</span>, xmax <span class="op">=</span> <span class="fl">1287</span>, ymin <span class="op">=</span> <span class="fl">13132</span>, ymax <span class="op">=</span> <span class="fl">13217</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  rasterPaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    capture <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_package.html" class="external-link">path_package</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"HSItools"</span>, <span class="st">"extdata/CORE_XYZ/CORE_XYZ.tif"</span><span class="op">)</span>,</span>
<span>    darkref <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_package.html" class="external-link">path_package</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"HSItools"</span>, <span class="st">"extdata/CORE_XYZ/DARKREF_CORE_XYZ.tif"</span><span class="op">)</span>,</span>
<span>    whiteref <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_package.html" class="external-link">path_package</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"HSItools"</span>, <span class="st">"extdata/CORE_XYZ/WHITEREF_CORE_XYZ.tif"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  directory <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_package.html" class="external-link">path_package</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"HSItools"</span>, <span class="st">"extdata/CORE_XYZ"</span><span class="op">)</span>,</span>
<span>  analysisRegions <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  distances <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    startCore <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fl">1</span>, x2 <span class="op">=</span> <span class="fl">1</span>, y1 <span class="op">=</span> <span class="fl">1</span>, y2 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    endCore <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fl">1</span>, x2 <span class="op">=</span> <span class="fl">1</span>, y1 <span class="op">=</span> <span class="fl">1</span>, y2 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    startScale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1159</span>, y <span class="op">=</span> <span class="fl">13204</span><span class="op">)</span>,</span>
<span>    endScale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1164</span>, y <span class="op">=</span> <span class="fl">13148</span><span class="op">)</span>,</span>
<span>    coreDist <span class="op">=</span> <span class="fl">56</span>,</span>
<span>    scaleDist <span class="op">=</span> <span class="fl">61</span>,</span>
<span>    scaleDistmm <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    pixelRatio <span class="op">=</span> <span class="fl">0.08196721</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h2>
<div class="section level3">
<h3 id="normalization">Normalization<a class="anchor" aria-label="anchor" href="#normalization"></a>
</h3>
<p>Before any spectral indices and properties are calculated,
normalizing the data and expressing it as a reflectance is
necessary.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Here we use run_core() output, so further function arguments are filled automatically.</span></span>
<span><span class="co"># Output is written to the file.</span></span>
<span><span class="va">reflectance</span> <span class="op">&lt;-</span> <span class="va">core</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/prepare_core.html">prepare_core</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          </span></span></code></pre></div>
<p>At this stage, we can plot the RGB preview. Our example file has only
eight random wavelengths, so it is impossible to plot true RGB. Instead,
we use the first, middle, and last available layer. Here it results in
somewhat gray image.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_raster_rgb.html">plot_raster_rgb</a></span><span class="op">(</span></span>
<span>  <span class="va">reflectance</span>,</span>
<span>  calibration <span class="op">=</span> <span class="fu"><a href="../reference/pixel_to_distance.html">pixel_to_distance</a></span><span class="op">(</span><span class="va">core</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/reflectance_rgb-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="spectral-smoothing">Spectral smoothing<a class="anchor" aria-label="anchor" href="#spectral-smoothing"></a>
</h3>
<p>Applying spectral smoothing, such as the Savitzky-Golay spectral
filter, is a good idea. Spurious, random peaks and through do not
influence the calculation results.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reflectance_smooth</span> <span class="op">&lt;-</span> <span class="va">reflectance</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Specify the file extension</span></span>
<span>  <span class="fu"><a href="../reference/filter_savgol.html">filter_savgol</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; |---------|---------|---------|---------|=========================================                                          </span></span></code></pre></div>
<p>We can plot the RGB preview at this stage, too.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_raster_rgb.html">plot_raster_rgb</a></span><span class="op">(</span></span>
<span>  <span class="va">reflectance_smooth</span>,</span>
<span>  calibration <span class="op">=</span> <span class="fu"><a href="../reference/pixel_to_distance.html">pixel_to_distance</a></span><span class="op">(</span><span class="va">core</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/savgol_rgb-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="peek-into-spectra">Peek into spectra<a class="anchor" aria-label="anchor" href="#peek-into-spectra"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Spectral profile from the entire ROI</span></span>
<span><span class="va">reflectance_sp</span> <span class="op">&lt;-</span> <span class="va">reflectance</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Use HSItools function to extract the profile</span></span>
<span>  <span class="fu"><a href="../reference/extract_spectral_profile.html">extract_spectral_profile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Pivot longer so for plotting</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"band"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"reflectance"</span>,</span>
<span>    names_transform <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="va"><a href="https://readr.tidyverse.org/reference/parse_number.html" class="external-link">parse_number</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Peek into data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">reflectance_sp</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 2</span></span></span>
<span><span class="co">#&gt;    band reflectance</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  561.       0.297</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  585.       0.303</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  610.       0.297</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  635.       0.298</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  660.       0.292</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>  685.       0.276</span></span>
<span></span>
<span><span class="co"># Spectral profile from the entire ROI</span></span>
<span><span class="va">reflectance_smooth_sp</span> <span class="op">&lt;-</span> <span class="va">reflectance_smooth</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Use HSItools function to extract the profile</span></span>
<span>  <span class="fu"><a href="../reference/extract_spectral_profile.html">extract_spectral_profile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Pivot longer so for plotting</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"band"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"reflectance_sg"</span>,</span>
<span>    names_transform <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="va"><a href="https://readr.tidyverse.org/reference/parse_number.html" class="external-link">parse_number</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Peek into data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">reflectance_smooth_sp</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 2</span></span></span>
<span><span class="co">#&gt;    band reflectance_sg</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  561.          0.297</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  585.          0.303</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  610.          0.297</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  635.          0.298</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  660.          0.292</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>  685.          0.277</span></span>
<span></span>
<span><span class="co"># Plot both profiles data</span></span>
<span><span class="va">sp_compare</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">reflectance_sp</span>,</span>
<span>  <span class="va">reflectance_smooth_sp</span>,</span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">band</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="op">-</span><span class="va">band</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"reflectance"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      <span class="va">band</span>,</span>
<span>      <span class="va">reflectance</span>,</span>
<span>      color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html" class="external-link">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Wavelength (nm)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Reflectance"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Spectrum type"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="va">sp_compare</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/peek-spectra-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="continuum-removal">Continuum removal<a class="anchor" aria-label="anchor" href="#continuum-removal"></a>
</h3>
<p>We can process our data further by removing the continuum, which
follows the rule of dividing the spectrum by its bounding box. This way,
the spectrum becomes flatter.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate reflectance with removed continuum</span></span>
<span><span class="co"># Use the smoothed spectrum</span></span>
<span><span class="va">reflectance_cr</span> <span class="op">&lt;-</span> <span class="va">reflectance_smooth</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/remove_continuum.html">remove_continuum</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; |---------|---------|---------|---------|=========================================                                          </span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="index-calculation">Index calculation<a class="anchor" aria-label="anchor" href="#index-calculation"></a>
</h2>
<p>At this point, it is OK to calculate selected indices or proxies.
Additionally, we provide calibration so depths are displayed as mm
rather than pixels (mind odd values).</p>
<p>Mean reflectance (<em>Rmean</em>)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rmean</span> <span class="op">&lt;-</span> <span class="va">reflectance_smooth</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/calculate_rmean.html">calculate_rmean</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_rmean</span> <span class="op">&lt;-</span> <span class="va">rmean</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/plot_raster_proxy.html">plot_raster_proxy</a></span><span class="op">(</span></span>
<span>    hsi_index <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rmean</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"mako"</span>,</span>
<span>    calibration <span class="op">=</span> <span class="fu"><a href="../reference/pixel_to_distance.html">pixel_to_distance</a></span><span class="op">(</span><span class="va">core</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="va">plot_rmean</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/rmean-plot-1.png" width="700"></p>
<div class="section level3">
<h3 id="relative-absorption-band-depth-rabd-">Relative Absorption Band Depth (RABD).<a class="anchor" aria-label="anchor" href="#relative-absorption-band-depth-rabd-"></a>
</h3>
<p>The RABD calculation has variations, but the results are generally
not drastically different. Let’s calculate one of the most common
indices to estimate the total chloropigments-a:
RABD<sub>660:670</sub>.</p>
<p>You can use predefined values or provide them manually. Let’s
calculate three different flavors.</p>
<p>The name of the output informs you about the calculated proxy and
additional modifications to the reflectance file; here, we see that it
was calculated with Savitzky-Golay smoothed reflectance.</p>
<div class="section level4">
<h4 id="variant-1-max">Variant 1: max<a class="anchor" aria-label="anchor" href="#variant-1-max"></a>
</h4>
<p>In this variant, a minimum reflectance is found in the trough for
each pixeland flexibly used for calculations.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rabd660670max</span> <span class="op">&lt;-</span> <span class="va">reflectance_smooth</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate max variant</span></span>
<span>  <span class="fu"><a href="../reference/calculate_rabd.html">calculate_rabd</a></span><span class="op">(</span></span>
<span>    edges <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">rabd_b660b670</span><span class="op">$</span><span class="va">edges</span>,</span>
<span>    trough <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">rabd_b660b670</span><span class="op">$</span><span class="va">trough</span>,</span>
<span>    rabd_name <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">rabd_b660b670</span><span class="op">$</span><span class="va">proxy_name</span>,</span>
<span>    rabd_type <span class="op">=</span> <span class="st">"max"</span><span class="op">)</span></span>
<span><span class="co">#&gt; |---------|---------|---------|---------|=========================================                                          </span></span></code></pre></div>
<p>Plot. Hyperspectral imaging data is most interesing when visualized.
We use <code>viridis</code> palettes. There is not much to see, and
values are unrealistic because the number of layers is dramatically
reduced.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare the plot</span></span>
<span><span class="va">plot_rabd660670max</span> <span class="op">&lt;-</span> <span class="va">rabd660670max</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/plot_raster_proxy.html">plot_raster_proxy</a></span><span class="op">(</span></span>
<span>    hsi_index <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rabd660670max</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"viridis"</span>,</span>
<span>    calibration <span class="op">=</span> <span class="fu"><a href="../reference/pixel_to_distance.html">pixel_to_distance</a></span><span class="op">(</span><span class="va">core</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="va">plot_rabd660670max</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/rabd-max-plot-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="variant-2-strict">Variant 2: strict<a class="anchor" aria-label="anchor" href="#variant-2-strict"></a>
</h4>
<p>This classic variant supplies a specific wavelength to calculate RABD
for every pixel.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rabd665</span> <span class="op">&lt;-</span> <span class="va">reflectance_smooth</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate max variant</span></span>
<span>  <span class="fu"><a href="../reference/calculate_rabd.html">calculate_rabd</a></span><span class="op">(</span></span>
<span>    edges <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">rabd_b660b670</span><span class="op">$</span><span class="va">edges</span>,</span>
<span>    trough <span class="op">=</span> <span class="fl">665</span>,</span>
<span>    rabd_name <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">rabd_b660b670</span><span class="op">$</span><span class="va">proxy_name</span>,</span>
<span>    rabd_type <span class="op">=</span> <span class="st">"strict"</span><span class="op">)</span></span>
<span><span class="co">#&gt; |---------|---------|---------|---------|=========================================                                          </span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare the plot</span></span>
<span><span class="va">plot_rabd665</span> <span class="op">&lt;-</span> <span class="va">rabd665</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/plot_raster_proxy.html">plot_raster_proxy</a></span><span class="op">(</span></span>
<span>    hsi_index <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rabd665</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"viridis"</span>,</span>
<span>    calibration <span class="op">=</span> <span class="fu"><a href="../reference/pixel_to_distance.html">pixel_to_distance</a></span><span class="op">(</span><span class="va">core</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="va">plot_rabd665</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/rabd-strict-plot-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="variant-3-midpoint">Variant 3: midpoint<a class="anchor" aria-label="anchor" href="#variant-3-midpoint"></a>
</h4>
<p>This is variant 2 (strict), with the added shortcut of always finding
the middle point between the through edges.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rabd660670mid</span> <span class="op">&lt;-</span> <span class="va">reflectance_smooth</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate max variant</span></span>
<span>  <span class="fu"><a href="../reference/calculate_rabd.html">calculate_rabd</a></span><span class="op">(</span></span>
<span>    edges <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">rabd_b660b670</span><span class="op">$</span><span class="va">edges</span>,</span>
<span>    trough <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">rabd_b660b670</span><span class="op">$</span><span class="va">trough</span>,</span>
<span>    rabd_name <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">rabd_b660b670</span><span class="op">$</span><span class="va">proxy_name</span>,</span>
<span>    rabd_type <span class="op">=</span> <span class="st">"mid"</span><span class="op">)</span></span>
<span><span class="co">#&gt; |---------|---------|---------|---------|=========================================                                          </span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare the plot</span></span>
<span><span class="va">plot_rabd660670mid</span> <span class="op">&lt;-</span> <span class="va">rabd660670mid</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/plot_raster_proxy.html">plot_raster_proxy</a></span><span class="op">(</span></span>
<span>    hsi_index <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rabd660670mid</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"viridis"</span>,</span>
<span>    calibration <span class="op">=</span> <span class="fu"><a href="../reference/pixel_to_distance.html">pixel_to_distance</a></span><span class="op">(</span><span class="va">core</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="va">plot_rabd660670mid</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/rabd-mid-plot-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="compare">Compare<a class="anchor" aria-label="anchor" href="#compare"></a>
</h4>
<p>We can compare these three plots side by side. We’re using
<code>patchwork</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_rabd660670max</span> <span class="op">+</span> <span class="va">plot_rabd665</span> <span class="op">+</span> <span class="va">plot_rabd660670mid</span> <span class="op">+</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/rabd-compare-1.png" width="700"></p>
<p>Similar, but not identical. As expected!</p>
</div>
</div>
<div class="section level3">
<h3 id="relative-absorption-band-area-raba">Relative Absorption Band Area (RABA)<a class="anchor" aria-label="anchor" href="#relative-absorption-band-area-raba"></a>
</h3>
</div>
<div class="section level3">
<h3 id="band-ratios">Band ratios<a class="anchor" aria-label="anchor" href="#band-ratios"></a>
</h3>
<p>Another popular and straightforward indices are band ratios, where
reflectance at the wavelength X is divided by reflectance at the
wavelength Y.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_ratio570630</span> <span class="op">&lt;-</span> <span class="va">ratio_570630</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/plot_raster_proxy.html">plot_raster_proxy</a></span><span class="op">(</span></span>
<span>    hsi_index <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ratio_570630</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"magma"</span>,</span>
<span>    calibration <span class="op">=</span> <span class="fu"><a href="../reference/pixel_to_distance.html">pixel_to_distance</a></span><span class="op">(</span><span class="va">core</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_ratio570630</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/ratio-plot-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="band-differences">Band differences<a class="anchor" aria-label="anchor" href="#band-differences"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">difference_650675</span> <span class="op">&lt;-</span> <span class="va">reflectance_smooth</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/calculate_band_difference.html">calculate_band_difference</a></span><span class="op">(</span></span>
<span>    difference_name <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">diff_b650b675</span><span class="op">$</span><span class="va">proxy_name</span>,</span>
<span>    edges <span class="op">=</span> <span class="va">proxies</span><span class="op">$</span><span class="va">diff_b650b675</span><span class="op">$</span><span class="va">edges</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_difference_650675</span> <span class="op">&lt;-</span> <span class="va">difference_650675</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/plot_raster_proxy.html">plot_raster_proxy</a></span><span class="op">(</span></span>
<span>    hsi_index <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">difference_650675</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"cividis"</span>,</span>
<span>    calibration <span class="op">=</span> <span class="fu"><a href="../reference/pixel_to_distance.html">pixel_to_distance</a></span><span class="op">(</span><span class="va">core</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_difference_650675</span></span></code></pre></div>
<p><img src="workflow_files/figure-html/difference-plot-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="derivatives">Derivatives<a class="anchor" aria-label="anchor" href="#derivatives"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># derivative_690 &lt;- reflectance_smooth |&gt;</span></span>
<span><span class="co">#   calculate_derivative(derivative_name = proxies$deriv_b690)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lambdaremp">lambdaREMP<a class="anchor" aria-label="anchor" href="#lambdaremp"></a>
</h3>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Maurycy Żarczyński, Nicholas McKay, David Edge.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
